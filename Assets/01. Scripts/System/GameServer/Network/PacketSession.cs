using System;
using System.Collections;
using System.Collections.Generic;
using System.Net;
using UnityEngine;

public abstract class PacketSession : Session
{
	public static readonly int HeaderSize = 2;

	public sealed override int OnRecv(ArraySegment<byte> buffer)
	{
		int processLen = 0;

		while (true)
		{
			// 최소한 헤더는 파싱할 수 있는지 확인
			if (buffer.Count < HeaderSize)
				break;

			// 패킷이 완전체로 도착했는지 확인
			ushort dataSize = BitConverter.ToUInt16(buffer.Array, buffer.Offset);
			if (buffer.Count < dataSize)
				break;

			// 여기까지 왔으면 패킷 조립 가능
			OnRecvPacket(new ArraySegment<byte>(buffer.Array, buffer.Offset, dataSize));

			processLen += dataSize;
			buffer = new ArraySegment<byte>(buffer.Array, buffer.Offset + dataSize, buffer.Count - dataSize);
		}

		return processLen;
	}

	public abstract void OnRecvPacket(ArraySegment<byte> buffer);

}
